<div class="transactions-container">
  <!-- Header -->
  <div class="page-header">
    <h1>Gelir & Gider Takibi</h1>
    <div class="header-actions">
      <button mat-raised-button color="primary" (click)="toggleAddForm()">
        <mat-icon>{{ showAddForm ? "close" : "add" }}</mat-icon>
        {{ showAddForm ? "İptal" : "Yeni İşlem" }}
      </button>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-section">
    <div class="stats-grid">
      <mat-card class="stat-card income-card">
        <mat-card-content>
          <div class="stat-header">
            <mat-icon>trending_up</mat-icon>
            <span>Toplam Gelir</span>
          </div>
          <div class="stat-value">
            {{ formatCurrency(filteredIncome || totalIncome) }}
          </div>
          <div class="stat-subtitle" *ngIf="filteredIncome !== totalIncome">
            Toplam: {{ formatCurrency(totalIncome) }}
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card expense-card">
        <mat-card-content>
          <div class="stat-header">
            <mat-icon>trending_down</mat-icon>
            <span>Toplam Gider</span>
          </div>
          <div class="stat-value">
            {{ formatCurrency(filteredExpense || totalExpense) }}
          </div>
          <div class="stat-subtitle" *ngIf="filteredExpense !== totalExpense">
            Toplam: {{ formatCurrency(totalExpense) }}
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card balance-card">
        <mat-card-content>
          <div class="stat-header">
            <mat-icon>account_balance</mat-icon>
            <span>Net Bakiye</span>
          </div>
          <div
            class="stat-value"
            [class]="
              (filteredIncome || totalIncome) -
                (filteredExpense || totalExpense) >=
              0
                ? 'positive'
                : 'negative'
            "
          >
            {{
              formatCurrency(
                (filteredIncome || totalIncome) -
                  (filteredExpense || totalExpense)
              )
            }}
          </div>
          <div class="stat-subtitle">Gelir - Gider</div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Add/Edit Transaction Form -->
  <mat-card class="form-card" *ngIf="showAddForm">
    <mat-card-header>
      <mat-card-title>
        {{ editingId ? "İşlem Düzenle" : "Yeni İşlem Ekle" }}
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form
        [formGroup]="transactionForm"
        (ngSubmit)="onSubmit()"
        class="transaction-form"
      >
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>İşlem Türü</mat-label>
            <mat-select
              formControlName="type"
              (selectionChange)="onTypeFilterChange()"
            >
              <mat-option value="" disabled>İşlem türü seçiniz</mat-option>
              <mat-option value="income">Gelir</mat-option>
              <mat-option value="expense">Gider</mat-option>
            </mat-select>
            <mat-error
              *ngIf="transactionForm.get('type')?.errors?.['required']"
            >
              İşlem türü seçiniz
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Kategori</mat-label>
            <mat-select formControlName="category">
              <mat-option value="" disabled>Kategori seçiniz</mat-option>
              <mat-option
                *ngFor="
                  let category of getCategoriesByType(
                    transactionForm.get('type')?.value
                  )
                "
                [value]="category.name"
              >
                <mat-icon [style.color]="category.color">{{
                  category.icon
                }}</mat-icon>
                {{ category.name }}
              </mat-option>
            </mat-select>
            <mat-error
              *ngIf="transactionForm.get('category')?.errors?.['required']"
            >
              Kategori seçiniz
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Tutar</mat-label>
            <input
              matInput
              type="number"
              step="0.01"
              formControlName="amount"
              placeholder="0.00"
            />
            <span matSuffix>₺</span>
            <mat-error
              *ngIf="transactionForm.get('amount')?.errors?.['required']"
            >
              Tutar giriniz
            </mat-error>
            <mat-error *ngIf="transactionForm.get('amount')?.errors?.['min']">
              Tutar 0'dan büyük olmalıdır
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Tarih</mat-label>
            <input matInput [matDatepicker]="picker" formControlName="date" />
            <mat-hint>GG/AA/YYYY</mat-hint>
            <mat-datepicker-toggle
              matSuffix
              [for]="picker"
            ></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-error
              *ngIf="transactionForm.get('date')?.errors?.['required']"
            >
              Tarih seçiniz
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Açıklama</mat-label>
            <input
              matInput
              formControlName="description"
              placeholder="İşlem açıklaması"
            />
            <mat-error
              *ngIf="transactionForm.get('description')?.errors?.['required']"
            >
              Açıklama giriniz
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-actions">
          <button
            mat-button
            type="button"
            (click)="resetForm()"
            [disabled]="loading"
          >
            İptal
          </button>
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="!transactionForm.valid || loading"
          >
            <mat-spinner diameter="20" *ngIf="loading"></mat-spinner>
            {{ editingId ? "Güncelle" : "Ekle" }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Filters -->
  <mat-card class="filter-card">
    <mat-card-header>
      <mat-card-title>Filtreler</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="filter-row">
        <mat-form-field appearance="outline">
          <mat-label>İşlem Türü</mat-label>
          <mat-select
            [(value)]="filterType"
            (selectionChange)="onTypeFilterChange()"
          >
            <mat-option value="all">Tümü</mat-option>
            <mat-option value="income">Gelir</mat-option>
            <mat-option value="expense">Gider</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Kategori</mat-label>
          <mat-select
            [(value)]="filterCategory"
            (selectionChange)="applyFilters()"
          >
            <mat-option value="all">Tümü</mat-option>
            <mat-option
              *ngFor="let category of getCategoriesByType(filterType)"
              [value]="category.name"
            >
              <mat-icon [style.color]="category.color">{{
                category.icon
              }}</mat-icon>
              {{ category.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Başlangıç Tarihi</mat-label>
          <input
            matInput
            [matDatepicker]="fromPicker"
            [(ngModel)]="filterDateFrom"
            (dateChange)="applyFilters()"
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="fromPicker"
          ></mat-datepicker-toggle>
          <mat-datepicker #fromPicker></mat-datepicker>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Bitiş Tarihi</mat-label>
          <input
            matInput
            [matDatepicker]="toPicker"
            [(ngModel)]="filterDateTo"
            (dateChange)="applyFilters()"
          />
          <mat-datepicker-toggle
            matSuffix
            [for]="toPicker"
          ></mat-datepicker-toggle>
          <mat-datepicker #toPicker></mat-datepicker>
        </mat-form-field>

        <button
          mat-raised-button
          color="accent"
          (click)="clearFilters()"
          class="clear-filters-btn"
        >
          <mat-icon>clear</mat-icon>
          Filtreleri Temizle
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Transactions Table -->
  <mat-card class="table-card">
    <mat-card-header>
      <mat-card-title>İşlemler</mat-card-title>
      <mat-card-subtitle>
        Toplam {{ dataSource.filteredData.length }} işlem
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="table-container">
        <table
          mat-table
          [dataSource]="dataSource"
          matSort
          class="transactions-table"
        >
          <!-- Date Column -->
          <ng-container matColumnDef="date">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Tarih</th>
            <td mat-cell *matCellDef="let transaction">
              {{ formatDate(transaction.date) }}
            </td>
          </ng-container>

          <!-- Type Column -->
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Tür</th>
            <td mat-cell *matCellDef="let transaction">
              <div class="transaction-type">
                <mat-icon [color]="getTransactionColor(transaction.type)">
                  {{ getTransactionIcon(transaction.type) }}
                </mat-icon>
                <span [class]="transaction.type">
                  {{ getTransactionTypeText(transaction.type) }}
                </span>
              </div>
            </td>
          </ng-container>

          <!-- Category Column -->
          <ng-container matColumnDef="category">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Kategori</th>
            <td mat-cell *matCellDef="let transaction">
              <mat-chip class="category-chip">
                {{ transaction.category }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Description Column -->
          <ng-container matColumnDef="description">
            <th mat-header-cell *matHeaderCellDef>Açıklama</th>
            <td mat-cell *matCellDef="let transaction">
              <span class="description">{{ transaction.description }}</span>
            </td>
          </ng-container>

          <!-- Amount Column -->
          <ng-container matColumnDef="amount">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Tutar</th>
            <td mat-cell *matCellDef="let transaction">
              <span class="amount" [class]="transaction.type">
                {{ transaction.type === "income" ? "+" : "-"
                }}{{ formatCurrency(transaction.amount) }}
              </span>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>İşlemler</th>
            <td mat-cell *matCellDef="let transaction">
              <div class="action-buttons">
                <button
                  mat-icon-button
                  color="primary"
                  (click)="editTransaction(transaction)"
                  matTooltip="Düzenle"
                >
                  <mat-icon>edit</mat-icon>
                </button>
                <button
                  mat-icon-button
                  color="warn"
                  (click)="deleteTransaction(transaction.id)"
                  matTooltip="Sil"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns"
            [class.highlight]="row.id === editingId"
          ></tr>
        </table>

        <!-- No data state -->
        <div class="no-data" *ngIf="dataSource.filteredData.length === 0">
          <mat-icon>receipt_long</mat-icon>
          <h3>Henüz işlem bulunmuyor</h3>
          <p>İlk işleminizi eklemek için "Yeni İşlem" butonuna tıklayın.</p>
          <button
            mat-raised-button
            color="primary"
            (click)="toggleAddForm()"
            *ngIf="!showAddForm"
          >
            <mat-icon>add</mat-icon>
            İlk İşlemi Ekle
          </button>
        </div>
      </div>

      <!-- Paginator -->
      <mat-paginator
        [pageSizeOptions]="[10, 25, 50, 100]"
        [pageSize]="25"
        showFirstLastButtons
        *ngIf="dataSource.filteredData.length > 0"
      >
      </mat-paginator>
    </mat-card-content>
  </mat-card>
</div>
