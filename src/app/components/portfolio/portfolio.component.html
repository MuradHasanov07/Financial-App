<div class="portfolio-container">
  <!-- Header -->
  <div class="page-header">
    <h1>Yatırım Portföyü</h1>
    <div class="header-actions">
      <button
        mat-raised-button
        color="accent"
        (click)="showPriceUpdate = !showPriceUpdate"
      >
        <mat-icon>update</mat-icon>
        Fiyat Güncelle
      </button>
      <button mat-raised-button color="primary" (click)="toggleAddForm()">
        <mat-icon>{{ showAddForm ? "close" : "add" }}</mat-icon>
        {{ showAddForm ? "İptal" : "Varlık Ekle" }}
      </button>
    </div>
  </div>

  <!-- Portfolio Statistics -->
  <div class="stats-section">
    <div class="stats-grid">
      <mat-card class="stat-card portfolio-value">
        <mat-card-content>
          <div class="stat-header">
            <mat-icon>account_balance_wallet</mat-icon>
            <span>Portföy Değeri</span>
          </div>
          <div class="stat-value">
            {{ formatCurrency(totalPortfolioValue) }}
          </div>
          <div class="stat-subtitle">Güncel piyasa değeri</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card investment">
        <mat-card-content>
          <div class="stat-header">
            <mat-icon>savings</mat-icon>
            <span>Toplam Yatırım</span>
          </div>
          <div class="stat-value">{{ formatCurrency(totalInvestment) }}</div>
          <div class="stat-subtitle">Alış değeri</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card profit-loss">
        <mat-card-content>
          <div class="stat-header">
            <mat-icon [color]="getChangeColor(totalProfitLoss)">
              {{ getChangeIcon(totalProfitLoss) }}
            </mat-icon>
            <span>Kar/Zarar</span>
          </div>
          <div
            class="stat-value"
            [class]="totalProfitLoss >= 0 ? 'positive' : 'negative'"
          >
            {{ formatCurrency(totalProfitLoss) }}
          </div>
          <div
            class="stat-subtitle"
            [class]="totalProfitLoss >= 0 ? 'positive' : 'negative'"
          >
            %{{ totalProfitLossPercentage.toFixed(2) }}
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card asset-count">
        <mat-card-content>
          <div class="stat-header">
            <mat-icon>category</mat-icon>
            <span>Toplam Varlık</span>
          </div>
          <div class="stat-value">{{ dataSource.data.length }}</div>
          <div class="stat-subtitle">Farklı yatırım</div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Asset Distribution -->
  <div class="distribution-section" *ngIf="assetDistribution.length > 0">
    <mat-card class="distribution-card">
      <mat-card-header>
        <mat-card-title>Portföy Dağılımı</mat-card-title>
        <mat-card-subtitle>Varlık türlerine göre</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <div class="distribution-grid">
          <div class="distribution-item" *ngFor="let item of assetDistribution">
            <div class="distribution-icon">
              <mat-icon [style.color]="getAssetTypeColor(item.type)">
                {{ getAssetTypeIcon(item.type) }}
              </mat-icon>
            </div>
            <div class="distribution-details">
              <div class="distribution-type">
                {{ getAssetTypeText(item.type) }}
              </div>
              <div class="distribution-value">
                {{ formatCurrency(item.value) }}
              </div>
            </div>
            <div class="distribution-percentage">
              <span>%{{ item.percentage.toFixed(1) }}</span>
              <mat-progress-bar
                mode="determinate"
                [value]="item.percentage"
                [color]="'primary'"
              >
              </mat-progress-bar>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Price Update Form -->
  <mat-card class="price-update-card" *ngIf="showPriceUpdate">
    <mat-card-header>
      <mat-card-title>Fiyat Güncelleme</mat-card-title>
      <mat-card-subtitle
        >Herhangi bir varlığın fiyatını güncelleyin</mat-card-subtitle
      >
    </mat-card-header>
    <mat-card-content>
      <form
        [formGroup]="priceUpdateForm"
        (ngSubmit)="onPriceUpdate()"
        class="price-form"
      >
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Varlık Seç</mat-label>
            <mat-select
              formControlName="symbol"
              (selectionChange)="onAssetSelectedForPriceUpdate()"
            >
              <mat-option value="" disabled>Varlık seçiniz</mat-option>

              <!-- Crypto Assets -->
              <mat-optgroup label="Kripto Para">
                <mat-option
                  *ngFor="let asset of predefinedAssets.crypto"
                  [value]="asset.symbol"
                >
                  {{ asset.name }} ({{ asset.symbol }}) -
                  {{
                    formatCurrency(assetService.getCurrentPrice(asset.symbol))
                  }}
                </mat-option>
              </mat-optgroup>

              <!-- Stock Assets -->
              <mat-optgroup label="Hisse Senedi">
                <mat-option
                  *ngFor="let asset of predefinedAssets.stock"
                  [value]="asset.symbol"
                >
                  {{ asset.name }} ({{ asset.symbol }}) -
                  {{
                    formatCurrency(assetService.getCurrentPrice(asset.symbol))
                  }}
                </mat-option>
              </mat-optgroup>

              <!-- Forex Assets -->
              <mat-optgroup label="Döviz">
                <mat-option
                  *ngFor="let asset of predefinedAssets.forex"
                  [value]="asset.symbol"
                >
                  {{ asset.name }} ({{ asset.symbol }}) -
                  {{
                    formatCurrency(assetService.getCurrentPrice(asset.symbol))
                  }}
                </mat-option>
              </mat-optgroup>
            </mat-select>
            <mat-error
              *ngIf="priceUpdateForm.get('symbol')?.errors?.['required']"
            >
              Varlık seçiniz
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Yeni Fiyat</mat-label>
            <input
              matInput
              type="number"
              step="0.01"
              formControlName="newPrice"
              placeholder="0.00"
            />
            <span matSuffix>₺</span>
            <mat-error
              *ngIf="priceUpdateForm.get('newPrice')?.errors?.['required']"
            >
              Fiyat giriniz
            </mat-error>
            <mat-error *ngIf="priceUpdateForm.get('newPrice')?.errors?.['min']">
              Fiyat 0'dan büyük olmalıdır
            </mat-error>
          </mat-form-field>

          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="!priceUpdateForm.valid"
          >
            <mat-icon>update</mat-icon>
            Güncelle
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Add/Edit Asset Form -->
  <mat-card class="form-card" *ngIf="showAddForm">
    <mat-card-header>
      <mat-card-title>
        {{ editingId ? "Varlık Düzenle" : "Yeni Varlık Ekle" }}
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <form [formGroup]="assetForm" (ngSubmit)="onSubmit()" class="asset-form">
        <!-- Asset Type Selection -->
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Varlık Türü</mat-label>
            <mat-select formControlName="type">
              <mat-option *ngFor="let type of assetTypes" [value]="type.id">
                <mat-icon [style.color]="type.color">{{ type.icon }}</mat-icon>
                {{ type.name }}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="assetForm.get('type')?.errors?.['required']">
              Varlık türü seçiniz
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Predefined Assets -->
        <div class="predefined-assets" *ngIf="getPredefinedAssets().length > 0">
          <label>Popüler Varlıklar:</label>
          <div class="predefined-chips">
            <mat-chip-listbox>
              <mat-chip-option
                *ngFor="let asset of getPredefinedAssets()"
                (click)="onPredefinedAssetSelect(asset)"
                class="predefined-chip"
              >
                {{ asset.symbol }} - {{ asset.name }}
              </mat-chip-option>
            </mat-chip-listbox>
          </div>
        </div>

        <!-- Asset Details -->
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Varlık Adı</mat-label>
            <input
              matInput
              formControlName="name"
              placeholder="Bitcoin, Akbank..."
            />
            <mat-error *ngIf="assetForm.get('name')?.errors?.['required']">
              Varlık adı giriniz
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Sembol</mat-label>
            <input
              matInput
              formControlName="symbol"
              placeholder="BTC, AKBNK..."
              style="text-transform: uppercase"
            />
            <mat-error *ngIf="assetForm.get('symbol')?.errors?.['required']">
              Sembol giriniz
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Miktar</mat-label>
            <input
              matInput
              type="number"
              step="0.000001"
              formControlName="quantity"
              placeholder="0.000000"
            />
            <mat-error *ngIf="assetForm.get('quantity')?.errors?.['required']">
              Miktar giriniz
            </mat-error>
            <mat-error *ngIf="assetForm.get('quantity')?.errors?.['min']">
              Miktar 0'dan büyük olmalıdır
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Alış Fiyatı</mat-label>
            <input
              matInput
              type="number"
              step="0.01"
              formControlName="purchasePrice"
              placeholder="0.00"
            />
            <span matSuffix>₺</span>
            <mat-error
              *ngIf="assetForm.get('purchasePrice')?.errors?.['required']"
            >
              Alış fiyatı giriniz
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Güncel Fiyat</mat-label>
            <input
              matInput
              type="number"
              step="0.01"
              formControlName="unitPrice"
              placeholder="0.00"
            />
            <span matSuffix>₺</span>
            <mat-error *ngIf="assetForm.get('unitPrice')?.errors?.['required']">
              Güncel fiyat giriniz
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Alış Tarihi</mat-label>
            <input
              matInput
              [matDatepicker]="picker"
              formControlName="purchaseDate"
            />
            <mat-hint>GG/AA/YYYY</mat-hint>
            <mat-datepicker-toggle
              matSuffix
              [for]="picker"
            ></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-error
              *ngIf="assetForm.get('purchaseDate')?.errors?.['required']"
            >
              Alış tarihi seçiniz
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-actions">
          <button
            mat-button
            type="button"
            (click)="resetForm()"
            [disabled]="loading"
          >
            İptal
          </button>
          <button
            mat-raised-button
            color="primary"
            type="submit"
            [disabled]="!assetForm.valid || loading"
          >
            <mat-spinner diameter="20" *ngIf="loading"></mat-spinner>
            {{ editingId ? "Güncelle" : "Ekle" }}
          </button>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Filters -->
  <mat-card class="filter-card">
    <mat-card-header>
      <mat-card-title>Filtreler</mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="filter-row">
        <mat-form-field appearance="outline">
          <mat-label>Varlık Türü</mat-label>
          <mat-select [(value)]="filterType" (selectionChange)="applyFilters()">
            <mat-option value="all">Tümü</mat-option>
            <mat-option *ngFor="let type of assetTypes" [value]="type.id">
              <mat-icon [style.color]="type.color">{{ type.icon }}</mat-icon>
              {{ type.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <button
          mat-raised-button
          color="accent"
          (click)="clearFilters()"
          class="clear-filters-btn"
        >
          <mat-icon>clear</mat-icon>
          Filtreleri Temizle
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Assets Table -->
  <mat-card class="table-card">
    <mat-card-header>
      <mat-card-title>Varlıklar</mat-card-title>
      <mat-card-subtitle>
        {{ dataSource.filteredData.length }} varlık gösteriliyor
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" matSort class="assets-table">
          <!-- Name Column -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Varlık</th>
            <td mat-cell *matCellDef="let asset">
              <div class="asset-info">
                <mat-icon [style.color]="getAssetTypeColor(asset.type)">
                  {{ getAssetTypeIcon(asset.type) }}
                </mat-icon>
                <div class="asset-details">
                  <div class="asset-name">{{ asset.name }}</div>
                  <div class="asset-symbol">{{ asset.symbol }}</div>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Type Column -->
          <ng-container matColumnDef="type">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Tür</th>
            <td mat-cell *matCellDef="let asset">
              <mat-chip
                class="type-chip"
                [style.background-color]="getAssetTypeColor(asset.type) + '20'"
                [style.color]="getAssetTypeColor(asset.type)"
              >
                {{ getAssetTypeText(asset.type) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Quantity Column -->
          <ng-container matColumnDef="quantity">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>Miktar</th>
            <td mat-cell *matCellDef="let asset">
              <span class="quantity">{{ asset.quantity }}</span>
            </td>
          </ng-container>

          <!-- Purchase Price Column -->
          <ng-container matColumnDef="purchasePrice">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Alış Fiyatı
            </th>
            <td mat-cell *matCellDef="let asset">
              <span class="price">{{
                formatCurrency(asset.purchasePrice)
              }}</span>
            </td>
          </ng-container>

          <!-- Current Price Column -->
          <ng-container matColumnDef="currentPrice">
            <th mat-header-cell *matHeaderCellDef>Güncel Fiyat</th>
            <td mat-cell *matCellDef="let asset">
              <span class="price">{{
                formatCurrency(getCurrentPrice(asset))
              }}</span>
            </td>
          </ng-container>

          <!-- Current Value Column -->
          <ng-container matColumnDef="currentValue">
            <th mat-header-cell *matHeaderCellDef mat-sort-header>
              Güncel Değer
            </th>
            <td mat-cell *matCellDef="let asset">
              <span class="current-value">{{
                formatCurrency(asset.currentValue || 0)
              }}</span>
            </td>
          </ng-container>

          <!-- Profit/Loss Column -->
          <ng-container matColumnDef="profitLoss">
            <th mat-header-cell *matHeaderCellDef>Kar/Zarar</th>
            <td mat-cell *matCellDef="let asset">
              <div class="profit-loss">
                <div
                  class="profit-loss-amount"
                  [class]="
                    calculateProfitLoss(asset) >= 0 ? 'positive' : 'negative'
                  "
                >
                  {{ formatCurrency(calculateProfitLoss(asset)) }}
                </div>
                <div
                  class="profit-loss-percentage"
                  [class]="
                    calculateProfitLoss(asset) >= 0 ? 'positive' : 'negative'
                  "
                >
                  <mat-icon>{{
                    getChangeIcon(calculateProfitLoss(asset))
                  }}</mat-icon>
                  {{ calculateProfitLossPercentage(asset).toFixed(2) }}%
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>İşlemler</th>
            <td mat-cell *matCellDef="let asset">
              <div class="action-buttons">
                <button
                  mat-icon-button
                  color="primary"
                  (click)="editAsset(asset)"
                  matTooltip="Düzenle"
                >
                  <mat-icon>edit</mat-icon>
                </button>
                <button
                  mat-icon-button
                  color="accent"
                  (click)="sellAsset(asset)"
                  matTooltip="Sat"
                >
                  <mat-icon>sell</mat-icon>
                </button>
                <button
                  mat-icon-button
                  color="warn"
                  (click)="deleteAsset(asset.id)"
                  matTooltip="Sil"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumns"
            [class.highlight]="row.id === editingId"
          ></tr>
        </table>

        <!-- No data state -->
        <div class="no-data" *ngIf="dataSource.filteredData.length === 0">
          <mat-icon>account_balance_wallet</mat-icon>
          <h3>Henüz varlık bulunmuyor</h3>
          <p>İlk yatırımınızı eklemek için "Varlık Ekle" butonuna tıklayın.</p>
          <button
            mat-raised-button
            color="primary"
            (click)="toggleAddForm()"
            *ngIf="!showAddForm"
          >
            <mat-icon>add</mat-icon>
            İlk Varlığı Ekle
          </button>
        </div>
      </div>

      <!-- Paginator -->
      <mat-paginator
        [pageSizeOptions]="[10, 25, 50]"
        [pageSize]="25"
        showFirstLastButtons
        *ngIf="dataSource.filteredData.length > 0"
      >
      </mat-paginator>
    </mat-card-content>
  </mat-card>
</div>
